<mat-toolbar color="primary" class="app-toolbar">
  <mat-icon class="logo-icon">psychology</mat-icon>
  <span class="app-title">Chess AI DQN</span>
  <span class="spacer"></span>
  <div class="turn-badge" [class.white-turn]="currentTurn === 'White'" [class.black-turn]="currentTurn === 'Black'">
    <span class="turn-piece">{{ currentTurn === 'White' ? 'â™”' : 'â™š' }}</span>
    {{ currentTurn }}'s Turn
    <span *ngIf="isThinking" class="thinking-dot"></span>
  </div>
</mat-toolbar>

<div class="game-container">
  <!-- Left: Board Area -->
  <div class="board-area">
    <mat-card class="board-wrapper">
      <!-- Board with rank labels -->
      <div class="board-with-ranks">
        <!-- Rank labels (left) -->
        <div class="rank-labels">
          <div *ngFor="let row of [0,1,2,3,4,5,6,7]" class="rank-label">{{ getRankLabel(row) }}</div>
        </div>

        <!-- Chessboard -->
        <div class="chessboard" [class.thinking]="isThinking">
          <div *ngFor="let row of displayBoard; let r = index" class="board-row">
            <div *ngFor="let piece of row; let c = index" class="square" [class]="getSquareClass(r, c)"
              [class.selected]="selectedSquare && highlightedSquares.has(selectedSquare)"
              [class.highlight]="getSquareHighlight(r, c)"
              [class.legal-move]="isLegalMoveSquare(r, c) && !isCaptureSquare(r, c)"
              [class.capture-move]="isCaptureSquare(r, c)" [class.clickable]="isPlayerTurn && !isThinking"
              [style.background]="getSquareHighlight(r, c) || ''" (click)="onSquareClick(r, c)">
              <!-- Legal move dot -->
              <div *ngIf="isLegalMoveSquare(r, c) && !isCaptureSquare(r, c) && !piece" class="move-dot"></div>
              <!-- Capture ring -->
              <div *ngIf="isCaptureSquare(r, c)" class="capture-ring"></div>
              <!-- Piece -->
              <img *ngIf="piece" [src]="getPieceImage(piece)" class="piece" draggable="false">
            </div>
          </div>
        </div>
      </div>

      <!-- File labels (bottom) -->
      <div class="file-labels">
        <div *ngFor="let col of [0,1,2,3,4,5,6,7]" class="file-label">{{ getFileLabel(col) }}</div>
      </div>
    </mat-card>

    <!-- Game Controls Bar -->
    <div class="controls-bar">
      <button mat-mini-fab color="warn" (click)="resetGame()" matTooltip="New Game">
        <mat-icon>refresh</mat-icon>
      </button>
      <button mat-mini-fab (click)="undoMove()" [disabled]="moveHistory.length < 2" matTooltip="Undo Move">
        <mat-icon>undo</mat-icon>
      </button>
      <button mat-mini-fab (click)="flipBoard()" matTooltip="Flip Board">
        <mat-icon>swap_vert</mat-icon>
      </button>
      <button mat-mini-fab color="primary" (click)="makeAIMove()" [disabled]="isThinking || isPlayerTurn"
        matTooltip="Force AI Move">
        <mat-icon>{{ isThinking ? 'hourglass_empty' : 'smart_toy' }}</mat-icon>
      </button>
    </div>

    <!-- Status Bar -->
    <div class="status-bar">
      <span class="phase-badge" [class]="gamePhase.toLowerCase()">{{ gamePhase }}</span>
      <span class="eval-badge" [class.positive]="evalScore >= 0" [class.negative]="evalScore < 0">
        {{ evalScore >= 0 ? '+' : '' }}{{ evalScore | number:'1.2-2' }}
      </span>
      <span class="move-count">Move {{ getMoveNumber() }}</span>
    </div>
  </div>

  <!-- Right: Side Panel -->
  <div class="side-panel">
    <!-- AI Settings Card -->
    <mat-card class="settings-card">
      <mat-card-header>
        <mat-card-title>ğŸ¤– AI Mode</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>AI Engine</mat-label>
          <mat-select [(ngModel)]="aiMode">
            <mat-option value="hybrid">
              ğŸš€ Hybrid (DQN + Lookahead)
            </mat-option>
            <mat-option value="dqn">
              âš¡ DQN Only (Fast, Trained)
            </mat-option>
            <mat-option value="turbo">
              ğŸ§  Turbo (Minimax Only)
            </mat-option>
          </mat-select>
        </mat-form-field>

        <div class="mode-description">
          <span *ngIf="aiMode === 'hybrid'">Uses trained model + plans ahead {{ searchDepth }} moves</span>
          <span *ngIf="aiMode === 'dqn'">Fast! Uses only trained network</span>
          <span *ngIf="aiMode === 'turbo'">Handcrafted heuristics, no training needed</span>
        </div>

        <div *ngIf="aiMode !== 'dqn'" class="depth-slider">
          <label>Search Depth: <strong>{{ searchDepth }}</strong></label>
          <mat-slider min="1" max="5" step="1" discrete>
            <input matSliderThumb [(ngModel)]="searchDepth">
          </mat-slider>
        </div>

        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Your Color</mat-label>
          <mat-select [(ngModel)]="playerColor">
            <mat-option value="white">â™” White</mat-option>
            <mat-option value="black">â™š Black</mat-option>
          </mat-select>
        </mat-form-field>
      </mat-card-content>
    </mat-card>

    <!-- Move History -->
    <mat-card class="history-card">
      <mat-card-header>
        <mat-card-title>ğŸ“œ Moves</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <div class="move-list" *ngIf="moveHistory.length > 0">
          <ng-container *ngFor="let move of moveHistory; let i = index">
            <span *ngIf="i % 2 === 0" class="move-number">{{ getMoveNumberAt(i) }}.</span>
            <span class="move-notation" [class.white-move]="i % 2 === 0" [class.black-move]="i % 2 === 1">
              {{ move }}
            </span>
          </ng-container>
        </div>
        <div *ngIf="moveHistory.length === 0" class="no-moves">No moves yet</div>
      </mat-card-content>
    </mat-card>

    <!-- AI Analysis (only when available) -->
    <mat-card class="analysis-card" *ngIf="thoughtProcess.length > 0">
      <mat-card-header>
        <mat-card-title>
          ğŸ§  Analysis
          <span class="score-chip" [class.positive]="evalScore >= 0" [class.negative]="evalScore < 0">
            {{ evalScore >= 0 ? '+' : '' }}{{ evalScore | number:'1.2-2' }}
          </span>
        </mat-card-title>
        <mat-card-subtitle *ngIf="principalVariation.length > 0">
          Best: {{ principalVariation.slice(0, 4).join(' â†’ ') }}
        </mat-card-subtitle>
      </mat-card-header>
      <mat-card-content>
        <div class="candidate-list">
          <div *ngFor="let item of thoughtProcess.slice(0, 5); let i = index" class="candidate-item"
            [class.best]="i === 0">
            <span class="rank">{{ i + 1 }}.</span>
            <span class="move-san">{{ item.move }}</span>
            <span class="score" [class.positive]="item.q_value >= 0" [class.negative]="item.q_value < 0">
              {{ item.q_value >= 0 ? '+' : '' }}{{ item.q_value | number:'1.2-2' }}
            </span>
          </div>
        </div>
      </mat-card-content>
    </mat-card>

    <!-- Strategic Factors (Hybrid and Turbo Mode) -->
    <mat-card class="factors-card" *ngIf="aiMode !== 'dqn' && strategicData">
      <mat-card-header>
        <mat-card-title>ğŸ“Š Position</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <div class="factor-row">
          <span>â™” Center</span>
          <span [class.positive]="strategicData.strategic_factors.center_control >= 0"
            [class.negative]="strategicData.strategic_factors.center_control < 0">
            {{ strategicData.strategic_factors.center_control | number:'1.2-2' }}
          </span>
        </div>
        <div class="factor-row">
          <span>â™ Development</span>
          <span [class.positive]="strategicData.strategic_factors.piece_development >= 0"
            [class.negative]="strategicData.strategic_factors.piece_development < 0">
            {{ strategicData.strategic_factors.piece_development | number:'1.2-2' }}
          </span>
        </div>
        <div class="factor-row">
          <span>ğŸ° King Safety</span>
          <span [class.positive]="strategicData.strategic_factors.king_safety >= 0"
            [class.negative]="strategicData.strategic_factors.king_safety < 0">
            {{ strategicData.strategic_factors.king_safety | number:'1.2-2' }}
          </span>
        </div>
        <div class="factor-row">
          <span>â™™ Pawns</span>
          <span [class.positive]="strategicData.strategic_factors.pawn_structure >= 0"
            [class.negative]="strategicData.strategic_factors.pawn_structure < 0">
            {{ strategicData.strategic_factors.pawn_structure | number:'1.2-2' }}
          </span>
        </div>
        <div class="factor-row">
          <span>âš¡ Mobility</span>
          <span [class.positive]="strategicData.strategic_factors.piece_mobility >= 0"
            [class.negative]="strategicData.strategic_factors.piece_mobility < 0">
            {{ strategicData.strategic_factors.piece_mobility | number:'1.2-2' }}
          </span>
        </div>
      </mat-card-content>
    </mat-card>
  </div>
</div>